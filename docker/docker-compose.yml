version: '3.8'

services:
  # SQL Server Database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: invoice-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Invoice@SecurePass123!
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - invoice-network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Invoice@SecurePass123!" -Q "SELECT 1" -C || exit 1
      interval: 10s
      timeout: 3s
      retries: 10

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management
    container_name: invoice-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin123
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - invoice-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: invoice-keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
      - KC_DB=dev-mem
    command: start-dev
    ports:
      - "8080:8080"
    networks:
      - invoice-network
    depends_on:
      - sqlserver

  # Jaeger for Distributed Tracing (Observability)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: invoice-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - invoice-network

networks:
  invoice-network:
    driver: bridge

volumes:
  sqlserver-data:
  rabbitmq-data:
